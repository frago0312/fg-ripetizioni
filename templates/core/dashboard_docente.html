{% extends 'base.html' %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1"><i class="bi bi-speedometer2 text-primary"></i> Dashboard Docente</h2>
        <p class="text-muted small mb-0">Panoramica amministrativa</p>
    </div>
    <div class="d-flex gap-2 mt-3 mt-md-0">
        <div class="card bg-success text-white border-0 px-3 py-2 d-flex flex-row align-items-center shadow-sm">
            <div class="me-3 fs-4"><i class="bi bi-cash-stack"></i></div>
            <div class="lh-1">
                <span class="d-block small opacity-75">Incasso Mese</span>
                <span class="fw-bold fs-5">€ {{ guadagno|floatformat:2 }}</span>
            </div>
        </div>
    </div>
</div>

{% if lista_pagamenti %}
<div class="card border-primary border-2 shadow mb-4">
    <div class="card-header bg-primary-subtle text-primary-emphasis fw-bold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-wallet2 me-2"></i> Pagamenti in Sospeso</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-body-secondary text-secondary small">
                <tr>
                    <th class="ps-3">Studente</th>
                    <th>Lezioni da saldare</th>
                    <th>Totale</th>
                    <th class="text-end pe-3">Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for item in lista_pagamenti %}
                <tr>
                    <td class="ps-3 fw-bold">{{ item.studente.first_name }} {{ item.studente.last_name }}</td>
                    <td><span class="badge bg-secondary">{{ item.numero_lezioni }} lezioni</span></td>
                    <td class="fw-bold text-danger">€ {{ item.totale|floatformat:2 }}</td>
                    <td class="text-end pe-3">
                        <div class="btn-group" role="group">
                            <a href="{% url 'gestione_pagamenti' item.studente.id 'invia_riepilogo' %}"
                               class="btn btn-outline-primary btn-sm"
                               onclick="return confirm('Inviare il riepilogo totale (€ {{ item.totale }}) via mail a {{ item.studente.first_name }}?')">
                                <i class="bi bi-envelope-at"></i> Mail
                            </a>

                            <a href="{% url 'gestione_pagamenti' item.studente.id 'segna_pagato' %}"
                               class="btn btn-success btn-sm"
                               onclick="return confirm('Confermi che {{ item.studente.first_name }} ha saldato tutto (€ {{ item.totale }})?')">
                                <i class="bi bi-check-circle"></i> Saldato
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if richieste %}
<div class="card border-warning border-2 shadow mb-4">
    <div class="card-header bg-warning-subtle text-warning-emphasis fw-bold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-bell-fill me-2"></i> Richieste in Attesa</span>
        <span class="badge bg-warning text-dark border border-dark rounded-circle">{{ richieste.count }}</span>
    </div>
    <div class="list-group list-group-flush">
        {% for lezione in richieste %}
        <div class="list-group-item p-3 bg-body">
            <div class="row align-items-center">
                <div class="col-md-4 mb-2 mb-md-0">
                    <h6 class="mb-0 fw-bold text-primary">{{ lezione.studente.first_name }} {{ lezione.studente.last_name }}</h6>
                    <small class="text-body-secondary">
                        {% if lezione.studente.profilo.telefono %}
                            <i class="bi bi-whatsapp text-success"></i> {{ lezione.studente.profilo.telefono }}
                        {% endif %}
                    </small>
                </div>
                <div class="col-md-4 mb-2 mb-md-0">
                    <div class="d-flex flex-column">
                        <span class="fw-bold"><i class="bi bi-calendar-event me-1"></i> {{ lezione.data_inizio|date:"l d/m H:i" }}</span>
                        <small class="text-body-secondary">{{ lezione.durata_ore }}h - {{ lezione.get_luogo_display }}</small>
                        {% if lezione.note %}<small class="fst-italic text-secondary">"{{ lezione.note }}"</small>{% endif %}
                    </div>
                </div>
                <div class="col-md-4 text-md-end d-flex gap-2 justify-content-md-end">
                    <a href="{% url 'gestisci_lezione' lezione.id 'accetta' %}" class="btn btn-success btn-sm flex-grow-1 flex-md-grow-0 px-3">
                        <i class="bi bi-check-lg"></i> Accetta
                    </a>
                    <a href="{% url 'gestisci_lezione' lezione.id 'rifiuta' %}" class="btn btn-outline-danger btn-sm flex-grow-1 flex-md-grow-0 px-3">
                        <i class="bi bi-x-lg"></i> Rifiuta
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="row g-4">
    <div class="col-lg-8">

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-transparent fw-bold py-3">
                <i class="bi bi-calendar-check me-2 text-primary"></i> Prossime Lezioni
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-body-secondary text-secondary small">
                            <tr>
                                <th class="ps-3">Data</th>
                                <th>Studente</th>
                                <th>Importo</th>
                                <th class="text-end pe-3">Stato Pagamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lezione in future %}
                            <tr>
                                <td class="ps-3">
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <span class="fw-bold text-primary">{{ lezione.data_inizio|date:"d/m" }}</span>
                                            <span class="ms-1 text-body-secondary">{{ lezione.data_inizio|date:"H:i" }}</span>
                                        </div>
                                        <a href="{{ lezione.get_google_calendar_url }}" target="_blank"
                                           class="btn btn-sm btn-outline-secondary border ms-2"
                                           title="Aggiungi al mio calendario">
                                            <i class="bi bi-calendar-plus"></i>
                                        </a>
                                    </div>
                                </td>
                                <td>
                                    {{ lezione.studente.first_name }} {{ lezione.studente.last_name|slice:":1" }}.
                                    <a href="https://wa.me/{{ lezione.studente.profilo.telefono|cut:' ' }}" target="_blank" class="text-success ms-1 text-decoration-none">
                                        <i class="bi bi-whatsapp"></i>
                                    </a>
                                </td>
                                <td>€{{ lezione.prezzo|floatformat:2 }}</td>
                                <td class="text-end pe-3">
                                    {% if lezione.pagata %}
                                        <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle"><i class="bi bi-check-all"></i> Pagata</span>
                                    {% else %}
                                        <a href="{% url 'gestisci_lezione' lezione.id 'pagata' %}" class="btn btn-sm btn-outline-secondary py-0" style="font-size: 0.75rem;">
                                            Segna Pagata
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-4 text-body-secondary">Nessuna lezione futura.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-transparent fw-bold py-3 d-flex justify-content-between align-items-center flex-wrap">
                <span><i class="bi bi-clock-history me-2 text-secondary"></i> Storico Lezioni Passate</span>
            </div>

            <div class="card-body bg-body-tertiary border-bottom p-3">
                <form method="get" class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Studente</label>
                        <select name="studente" class="form-select form-select-sm">
                            <option value="">Tutti</option>
                            {% for s in studenti_con_lezioni %}
                                <option value="{{ s.id }}" {% if filtro_studente == s.id|stringformat:"s" %}selected{% endif %}>
                                    {{ s.first_name }} {{ s.last_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Dal</label>
                        <input type="date" name="dal" value="{{ filtro_dal }}" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-body-secondary mb-1">Al</label>
                        <input type="date" name="al" value="{{ filtro_al }}" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-3 d-flex gap-1">
                        <button type="submit" class="btn btn-primary btn-sm flex-grow-1"><i class="bi bi-funnel"></i> Filtra</button>
                        {% if filtro_studente or filtro_dal or filtro_al %}
                            <a href="{% url 'dashboard_docente' %}" class="btn btn-outline-secondary btn-sm" title="Rimuovi Filtri"><i class="bi bi-x-circle"></i></a>
                        {% endif %}
                    </div>
                </form>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-body-secondary text-body-secondary small" style="position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th class="ps-3">Data</th>
                                <th>Studente</th>
                                <th>Ore</th>
                                <th>Importo</th>
                                <th class="text-end pe-3">Stato</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lezione in passate %}
                            <tr>
                                <td class="ps-3 fw-bold text-body-secondary">{{ lezione.data_inizio|date:"d/m/Y" }}</td>
                                <td>{{ lezione.studente.first_name }} {{ lezione.studente.last_name }}</td>
                                <td>{{ lezione.durata_ore }} h</td>
                                <td>€{{ lezione.prezzo|floatformat:2 }}</td>
                                <td class="text-end pe-3">
                                    {% if lezione.pagata %}
                                        <span class="text-success small"><i class="bi bi-check-circle-fill"></i> Pagata</span>
                                    {% else %}
                                        <span class="text-danger small"><i class="bi bi-exclamation-circle-fill"></i> Da Saldare</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center py-4 text-body-secondary">Nessuna lezione trovata con questi filtri.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer bg-body-tertiary d-flex justify-content-between align-items-center py-3">
                <span class="text-body-secondary small text-uppercase fw-bold">Totali Filtrati:</span>
                <div class="d-flex gap-4">
                    <span class="fs-6"><i class="bi bi-clock me-1 text-secondary"></i> <strong>{{ totale_ore_passate|floatformat:1 }} h</strong></span>
                    <span class="fs-6"><i class="bi bi-cash me-1 text-success"></i> <strong class="text-success">€ {{ totale_importo_passate|floatformat:2 }}</strong></span>
                </div>
            </div>
        </div>

    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h6 class="fw-bold text-body-secondary text-uppercase small mb-3">Tariffa Base</h6>
                <form method="post" class="d-flex">
                    {% csrf_token %}
                    <input type="hidden" name="btn_tariffa" value="1">
                    <div class="input-group">
                        <span class="input-group-text">€</span>
                        {{ form_tariffa.tariffa_base }}
                        <button class="btn btn-dark" type="submit">Salva</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="accordion shadow-sm" id="configAccordion">

            <div class="accordion-item border-0">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed fw-bold bg-body-tertiary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOrari">
                        <i class="bi bi-clock me-2 text-info"></i> Orari Settimanali
                    </button>
                </h2>
                <div id="collapseOrari" class="accordion-collapse collapse" data-bs-parent="#configAccordion">
                    <div class="accordion-body bg-body-tertiary">
                        <form method="post" class="mb-3">
                            {% csrf_token %}
                            <input type="hidden" name="btn_disponibilita" value="1">
                            <div class="row g-2">
                                <div class="col-12">{{ form_disp.giorno }}</div>
                                <div class="col-5">{{ form_disp.ora_inizio }}</div>
                                <div class="col-5">{{ form_disp.ora_fine }}</div>
                                <div class="col-2"><button class="btn btn-info text-white w-100 p-1" type="submit"><i class="bi bi-plus"></i></button></div>
                            </div>
                        </form>
                        <ul class="list-group list-group-flush small">
                            {% for d in disponibilita_list %}
                            <li class="list-group-item bg-transparent text-body-secondary d-flex justify-content-between align-items-center px-0">
                                <span><strong>{{ d.get_giorno_display }}</strong> {{ d.ora_inizio|date:"H:i" }}-{{ d.ora_fine|date:"H:i" }}</span>
                                <a href="{% url 'elimina_disponibilita' d.id %}" class="text-danger"><i class="bi bi-trash"></i></a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <div class="accordion-item border-0 border-top">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed fw-bold bg-body-tertiary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFerie">
                        <i class="bi bi-calendar-x me-2 text-danger"></i> Ferie & Chiusure
                    </button>
                </h2>
                <div id="collapseFerie" class="accordion-collapse collapse" data-bs-parent="#configAccordion">
                    <div class="accordion-body bg-body-tertiary">
                        <form method="post" class="mb-3">
                            {% csrf_token %}
                            <input type="hidden" name="btn_chiusura" value="1">
                            <div class="mb-2">{{ form_chiusura.data_inizio }}</div>
                            <div class="mb-2">{{ form_chiusura.data_fine }}</div>
                            <div class="input-group input-group-sm">
                                {{ form_chiusura.motivo }}
                                <button class="btn btn-danger" type="submit">Blocca</button>
                            </div>
                        </form>
                        <ul class="list-group list-group-flush small">
                            {% for c in chiusure_future %}
                            <li class="list-group-item bg-transparent text-body-secondary d-flex justify-content-between align-items-center px-0">
                                <span><span class="text-danger fw-bold">{{ c.data_inizio|date:"d/m" }}</span>: {{ c.motivo }}</span>
                                <a href="{% url 'elimina_chiusura' c.id %}" class="text-body-secondary"><i class="bi bi-trash"></i></a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}