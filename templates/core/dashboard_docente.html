{% extends 'base.html' %}

{% block content %}
<div class="mb-4">
    <h2 class="text-primary fw-bold"><i class="bi bi-speedometer2"></i> Dashboard Docente</h2>
    <p class="text-muted small">Pannello di controllo amministrativo</p>
</div>

<div class="row g-3 mb-4">

    <div class="col-md-4">
        <div class="card shadow-sm border-left-success h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-muted mb-2 small fw-bold">Tariffa Base Oraria</h6>
                <form method="post" class="d-flex align-items-center">
                    {% csrf_token %}
                    <input type="hidden" name="btn_tariffa" value="1">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-success text-success">€</span>
                        {{ form_tariffa.tariffa_base }}
                        <button class="btn btn-success" type="submit">Salva</button>
                    </div>
                </form>
                <small class="text-muted" style="font-size: 0.7rem;">Modifica il prezzo base per le nuove lezioni.</small>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-left-primary h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-muted mb-2 small fw-bold">Esporta Excel</h6>
                <form action="{% url 'export_lezioni_csv' %}" method="get">
                    <div class="d-flex gap-1 mb-2">
                        <input type="date" name="dal" class="form-control form-control-sm" placeholder="Dal">
                        <input type="date" name="al" class="form-control form-control-sm" placeholder="Al">
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Scarica CSV
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-left-success h-100 bg-light">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h6 class="text-uppercase text-muted mb-1 small fw-bold">Guadagno Mese (Pagato)</h6>
                <h2 class="text-success fw-bold m-0">€ {{ guadagno }}</h2>
                <small class="text-muted" style="font-size: 0.7rem;">Incassato questo mese</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card shadow border-left-warning h-100">
            <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-hourglass-split"></i> Richieste in Attesa</span>
                <span class="badge bg-dark text-white rounded-pill">{{ richieste.count }}</span>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for lezione in richieste %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 fw-bold">{{ lezione.studente.first_name }} {{ lezione.studente.last_name }}</h6>
                            <span class="badge bg-light text-dark border">{{ lezione.data_inizio|date:"d/m H:i" }}</span>
                        </div>
                        <p class="mb-2 small text-muted">
                            {{ lezione.durata_ore }}h - {{ lezione.get_luogo_display }} <br>
                            {% if lezione.note %}
                                <i class="bi bi-chat-quote"></i> <em>{{ lezione.note }}</em>
                            {% endif %}
                        </p>

                        <div class="d-flex gap-2">
                            <a href="{% url 'gestisci_lezione' lezione.id 'accetta' %}" class="btn btn-success btn-sm flex-grow-1">
                                <i class="bi bi-check-lg"></i> Accetta
                            </a>
                            <a href="{% url 'gestisci_lezione' lezione.id 'rifiuta' %}" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-x-lg"></i>
                            </a>

                            {% if lezione.studente.profilo.telefono %}
                            <a href="https://wa.me/{{ lezione.studente.profilo.telefono|cut:' ' }}" target="_blank" class="btn btn-success btn-sm" style="background-color: #25D366; border:none;" title="Scrivi su WhatsApp">
                                <i class="bi bi-whatsapp"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-check-circle fs-3 d-block mb-2"></i>
                        Nessuna richiesta in attesa.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow border-left-primary h-100">
            <div class="card-header bg-primary text-white fw-bold">
                <i class="bi bi-calendar-event"></i> Prossime Lezioni
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">Data</th>
                                <th>Studente</th>
                                <th>€</th>
                                <th class="text-end pe-3">Stato</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lezione in future|slice:":10" %}
                            <tr>
                                <td class="ps-3 fw-bold text-primary">{{ lezione.data_inizio|date:"d/m H:i" }}</td>
                                <td>
                                    {{ lezione.studente.first_name }}
                                    {% if lezione.studente.profilo.telefono %}
                                    <a href="https://wa.me/{{ lezione.studente.profilo.telefono|cut:' ' }}" target="_blank" class="text-success ms-1 small">
                                        <i class="bi bi-whatsapp"></i>
                                    </a>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>€{{ lezione.prezzo }}</small>
                                </td>
                                <td class="text-end pe-3">
                                    {% if lezione.pagata %}
                                        <span class="badge bg-success"><i class="bi bi-check"></i> Pagata</span>
                                    {% else %}
                                        <a href="{% url 'gestisci_lezione' lezione.id 'pagata' %}" class="btn btn-outline-secondary btn-sm py-0" style="font-size: 0.7rem;">
                                            Segna Pagata
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center p-4 text-muted">Nessuna lezione futura in programma.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">

    <div class="col-lg-6">
        <div class="card shadow border-left-info h-100">
            <div class="card-header bg-info text-white fw-bold">
                <i class="bi bi-clock"></i> Orari Settimanali
            </div>
            <div class="card-body">
                <form method="post" class="mb-4 p-3 bg-light rounded">
                    {% csrf_token %}
                    <input type="hidden" name="btn_disponibilita" value="1">
                    <h6 class="small text-muted fw-bold mb-2">AGGIUNGI / MODIFICA ORARIO</h6>

                    <div class="row g-2 align-items-end">
                        <div class="col-12">
                            {{ form_disp.giorno }}
                        </div>
                        <div class="col-5">
                            <label class="small text-muted">Inizio</label>
                            {{ form_disp.ora_inizio }}
                        </div>
                        <div class="col-5">
                            <label class="small text-muted">Fine</label>
                            {{ form_disp.ora_fine }}
                        </div>
                        <div class="col-2">
                            <button type="submit" class="btn btn-info text-white w-100"><i class="bi bi-plus-lg"></i></button>
                        </div>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <tbody>
                            {% for d in disponibilita_list %}
                            <tr>
                                <td class="fw-bold">{{ d.get_giorno_display }}</td>
                                <td>{{ d.ora_inizio|date:"H:i" }} - {{ d.ora_fine|date:"H:i" }}</td>
                                <td class="text-end">
                                    <a href="{% url 'elimina_disponibilita' d.id %}" class="text-danger" onclick="return confirm('Eliminare?');">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center small text-muted">Nessuna disponibilità impostata.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow border-left-danger h-100">
            <div class="card-header bg-danger text-white fw-bold">
                <i class="bi bi-calendar-x"></i> Ferie & Chiusure
            </div>
            <div class="card-body">
                <form method="post" class="mb-4 p-3 bg-light rounded">
                    {% csrf_token %}
                    <input type="hidden" name="btn_chiusura" value="1">
                    <h6 class="small text-muted fw-bold mb-2">BLOCCA DATE</h6>

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="small text-muted">Dal</label>
                            {{ form_chiusura.data_inizio }}
                        </div>
                        <div class="col-6">
                            <label class="small text-muted">Al (Opzionale)</label>
                            {{ form_chiusura.data_fine }}
                        </div>
                        <div class="col-12 mt-2">
                            <div class="input-group">
                                {{ form_chiusura.motivo }}
                                <button type="submit" class="btn btn-danger"><i class="bi bi-lock-fill"></i></button>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <tbody>
                            {% for c in chiusure_future %}
                            <tr>
                                <td>
                                    <span class="fw-bold text-danger">
                                        {% if c.data_inizio == c.data_fine %}
                                            {{ c.data_inizio|date:"d M" }}
                                        {% else %}
                                            {{ c.data_inizio|date:"d/m" }}-{{ c.data_fine|date:"d/m" }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="small text-muted">{{ c.motivo }}</td>
                                <td class="text-end">
                                    <a href="{% url 'elimina_chiusura' c.id %}" class="text-secondary" onclick="return confirm('Riaprire queste date?');">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center small text-muted">Nessuna chiusura programmata.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}